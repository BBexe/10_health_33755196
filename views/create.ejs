<%- include('header') %>
    <link rel="stylesheet" href="/css/routines.css">

    <!-- Main layout for routine creation page -->
    <div class="routine-creator-layout">
        <h1>Create New Routine</h1>

        <!-- Form for creating a new routine -->
        <form action="./" method="POST" style="max-width: 600px;">
            <!-- Routine name input -->
            <div class="form-group">
                <label>Routine Name:</label>
                <input type="text" name="routine_name" required>
            </div>

            <!-- Routine description input -->
            <div class="form-group">
                <label>Description:</label>
                <textarea name="description" rows="4"></textarea>
            </div>

            <!-- Form action buttons (Save/Cancel) -->
            <div class="form-actions">
                <button type="submit">Save Routine</button>
                <a href="<%= url('/routines/cancel-creation') %>" class="btn-danger" id="cancelBtn">Cancel</a>
            </div>
        </form>

        <!-- Section for managing exercises in the routine -->
        <div class="exercise-section">
            <h3>Exercises</h3>

            <% if (tempRoutine.exercises && tempRoutine.exercises.length> 0) { %>
                <!-- List of exercises added to the routine -->
                <div class="exercises-list">
                    <% tempRoutine.exercises.forEach((exercise, index)=> { %>
                        <!-- Single exercise item -->
                        <div class="exercise-item">
                            <!-- Exercise info (name, sets, reps) -->
                            <div class="exercise-info">
                                <strong>
                                    <%= exercise.exercise_name %>
                                </strong>
                                <span>
                                    <%= exercise.sets %> sets x <%= exercise.reps %> reps
                                </span>
                            </div>
                            <!-- Form to remove an exercise from the routine -->
                            <form action="remove-exercise" method="POST" style="display: inline;">
                                <input type="hidden" name="index" value="<%= index %>">
                                <input type="hidden" name="query"
                                    value="<%= typeof currentQuery !== 'undefined' ? currentQuery : '' %>">
                                <button type="submit" class="btn-remove">Remove</button>
                            </form>
                        </div>
                        <% }); %>
                </div>
                <% } else { %>
                    <!-- Message when no exercises are added -->
                    <p class="empty-message">No exercises added yet.</p>
                    <% } %>

                        <h4>Add Exercise</h4>

                        <!-- Form to search for exercises -->
                        <form action="search" method="POST" style="margin: 1rem 0;">
                            <!-- Search input for exercises -->
                            <div class="form-group">
                                <label>Search Exercise:</label>
                                <input type="text" name="query" placeholder="Type to search exercises..."
                                    autocomplete="off" required
                                    value="<%= typeof currentQuery !== 'undefined' ? currentQuery : '' %>">
                            </div>
                            <div class="form-actions" style="margin-top: 10px;">
                                <button type="submit">Search</button>
                                <% if (typeof currentQuery !=='undefined' && currentQuery) { %>
                                    <a href="<%= url('/routines/new') %>" class="clear-search"
                                        style="margin-left: 10px;">Clear</a>
                                    <% } %>
                            </div>
                        </form>

                        <% if (searchResults && searchResults.length> 0) { %>
                            <!-- List of search results for exercises -->
                            <div class="search-results-list">
                                <p><strong>Search Results:</strong></p>
                                <% searchResults.forEach(result=> { %>
                                    <!-- Form to add a searched exercise to the routine -->
                                    <form action="add-exercise" method="POST" class="add-exercise-form">
                                        <input type="hidden" name="exercise_id" value="<%= result.data.id %>">
                                        <input type="hidden" name="exercise_name" value="<%= result.value %>">
                                        <!-- Pass query to persist search context -->
                                        <input type="hidden" name="query" value="<%= currentQuery %>">

                                        <!-- Single search result item -->
                                        <div class="result-item">
                                            <div>
                                                <%= result.value %>
                                            </div>
                                            <div>
                                                <label>Sets: <input type="number" name="sets" value="3" min="1"
                                                        style="width: 60px;"></label>
                                                <label>Reps: <input type="number" name="reps" value="10" min="1"
                                                        style="width: 60px;"></label>
                                                <button type="submit">Add</button>
                                            </div>
                                        </div>
                                    </form>
                                    <% }); %>
                            </div>
                            <% } %>
        </div>
    </div>

    <%- include('footer') %>

        <script>
            // Persistence Logic: Keep Name/Description AND Scroll Position
            document.addEventListener('DOMContentLoaded', () => {
                const nameInput = document.querySelector('input[name="routine_name"]');
                const descInput = document.querySelector('textarea[name="description"]');
                const mainForm = document.querySelector('form[action="./"]');

                // Restore Scroll Position
                const scrollPos = sessionStorage.getItem('scrollPos');
                if (scrollPos) {
                    window.scrollTo(0, parseInt(scrollPos));
                    sessionStorage.removeItem('scrollPos'); // Clear after restoring
                }

                // Restore Inputs
                if (sessionStorage.getItem('temp_routine_name')) {
                    nameInput.value = sessionStorage.getItem('temp_routine_name');
                }
                if (sessionStorage.getItem('temp_routine_desc')) {
                    descInput.value = sessionStorage.getItem('temp_routine_desc');
                }

                // Save Inputson change
                nameInput.addEventListener('input', () => {
                    sessionStorage.setItem('temp_routine_name', nameInput.value);
                });
                descInput.addEventListener('input', () => {
                    sessionStorage.setItem('temp_routine_desc', descInput.value);
                });

                // Save Scroll Position before unload (reload)
                window.addEventListener('beforeunload', () => {
                    sessionStorage.setItem('scrollPos', window.scrollY);
                });

                // Clear Everything on successful Save (Submit Main Form)
                mainForm.addEventListener('submit', () => {
                    sessionStorage.removeItem('temp_routine_name');
                    sessionStorage.removeItem('temp_routine_desc');
                    sessionStorage.removeItem('scrollPos');
                });

                // Clear Everything on Cancel
                document.getElementById('cancelBtn').addEventListener('click', () => {
                    sessionStorage.removeItem('temp_routine_name');
                    sessionStorage.removeItem('temp_routine_desc');
                    sessionStorage.removeItem('scrollPos');
                });
            });
        </script>